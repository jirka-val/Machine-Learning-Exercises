<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Clustering Analysis</title>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  
  
  <style>
    .step-container {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .step-title {
      color: #495057;
      font-weight: 600;
      margin-bottom: 15px;
    }
    
    .feature-card {
      border: 2px solid #e9ecef;
      border-radius: 8px;
      padding: 15px;
      margin: 10px 0;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .feature-card:hover {
      border-color: #007bff;
      background-color: #f8f9fa;
    }
    
    .feature-card.selected {
      border-color: #28a745;
      background-color: #d4edda;
    }
    
    .loading {
      display: none;
      text-align: center;
      padding: 20px;
    }
    
    .result-section {
      margin-top: 30px;
      padding: 20px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .stats-card {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
      margin: 10px 0;
    }
    
    .cluster-stats {
      max-height: 400px;
      overflow-y: auto;
    }
  </style>
</head>
<body class="bg-light">
  <div class="container py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1 class="m-0">Apartment Clustering Analysis</h1>
      <div>
        <a href="/" class="btn btn-outline-secondary me-2">Back to List</a>
        <a href="/analytics" class="btn btn-outline-info">Price Analysis</a>
        <a href="/clustering_viz" class="btn btn-outline-success">Interactive Visualization</a>
      </div>
    </div>

    <!-- Step 1: Feature Selection -->
    <div class="step-container">
      <h3 class="step-title">1. Feature Selection</h3>
      <p class="text-muted">Select numerical features for clustering analysis:</p>
      
      <div id="feature-selection">
        <div class="row">
          <div class="col-md-6">
            <div class="feature-card" data-feature="price_num">
              <h5>Price (CZK)</h5>
              <p class="text-muted mb-0">Total apartment price</p>
            </div>
          </div>
          <div class="col-md-6">
            <div class="feature-card" data-feature="rooms">
              <h5>Number of Rooms</h5>
              <p class="text-muted mb-0">Number of rooms in the apartment</p>
            </div>
          </div>
          <div class="col-md-6">
            <div class="feature-card" data-feature="area_m2">
              <h5>Size (m²)</h5>
              <p class="text-muted mb-0">Apartment area in square meters</p>
            </div>
          </div>
          <div class="col-md-6">
            <div class="feature-card" data-feature="price_per_m2">
              <h5>Price per m² (CZK)</h5>
              <p class="text-muted mb-0">Price per square meter</p>
            </div>
          </div>
        </div>
        
        <div class="mt-3">
          <button id="show-histograms" class="btn btn-primary" disabled>
            Show Histograms of Selected Features
          </button>
        </div>
      </div>
    </div>

    <!-- Histogram Section -->
    <div id="histogram-section" class="step-container" style="display: none;">
      <h3 class="step-title">Histograms of Selected Features</h3>
      <div id="histogram-container" class="text-center">
        <img id="histogram-image" class="img-fluid" style="max-width: 100%; height: auto;">
      </div>
    </div>

    <!-- Step 2: Preprocessing -->
    <div class="step-container">
      <h3 class="step-title">2. Preprocessing</h3>
      <p class="text-muted">Select scaling method for each feature:</p>
      
      <div id="feature-scaler-config" style="display: none;">
        <!-- Feature scaler configurations will be populated here -->
      </div>
      
      <div class="alert alert-info">
        <strong>Tip:</strong> You can use different scaling methods for different features. 
        PowerTransformer is useful for data with non-normal distribution.
      </div>
    </div>

    <!-- Step 3: Algorithm Selection -->
    <div class="step-container">
      <h3 class="step-title">3. Algorithm Selection</h3>
      <p class="text-muted">Select clustering algorithm and set parameters:</p>
      
      <div class="row">
        <div class="col-md-4">
          <div class="form-check">
            <input class="form-check-input" type="radio" name="algorithm" id="algorithm-kmeans" value="kmeans" checked>
            <label class="form-check-label" for="algorithm-kmeans">
              <strong>K-means</strong><br>
              <small class="text-muted">Partition into k clusters</small>
            </label>
          </div>
        </div>
        <div class="col-md-4">
          <div class="form-check">
            <input class="form-check-input" type="radio" name="algorithm" id="algorithm-dbscan" value="dbscan">
            <label class="form-check-label" for="algorithm-dbscan">
              <strong>DBSCAN</strong><br>
              <small class="text-muted">Density-based clustering</small>
            </label>
          </div>
        </div>
        <div class="col-md-4">
          <div class="form-check">
            <input class="form-check-input" type="radio" name="algorithm" id="algorithm-agglomerative" value="agglomerative">
            <label class="form-check-label" for="algorithm-agglomerative">
              <strong>Agglomerative</strong><br>
              <small class="text-muted">Hierarchical clustering</small>
            </label>
          </div>
        </div>
      </div>

      <!-- Algorithm Parameters -->
      <div id="algorithm-params" class="mt-3">
        <!-- K-means parameters -->
        <div id="kmeans-params" class="algorithm-param-group">
          <div class="row">
            <div class="col-md-6">
              <label for="n-clusters" class="form-label">Number of clusters:</label>
              <input type="number" class="form-control" id="n-clusters" value="3" min="2" max="10">
            </div>
            <div class="col-md-6">
              <label class="form-label">Cluster count analysis:</label>
              <div class="btn-group w-100" role="group">
                <button type="button" class="btn btn-outline-primary btn-sm" id="silhouette-btn">Silhouette</button>
                <button type="button" class="btn btn-outline-primary btn-sm" id="elbow-btn">Elbow</button>
              </div>
            </div>
          </div>
        </div>

        <!-- DBSCAN parameters -->
        <div id="dbscan-params" class="algorithm-param-group" style="display: none;">
          <div class="row">
            <div class="col-md-6">
              <label for="eps" class="form-label">Eps (distance):</label>
              <input type="number" class="form-control" id="eps" value="0.5" min="0.1" max="2.0" step="0.1">
            </div>
            <div class="col-md-6">
              <label for="min-samples" class="form-label">Min. samples:</label>
              <input type="number" class="form-control" id="min-samples" value="5" min="2" max="20">
            </div>
          </div>
        </div>

        <!-- Agglomerative parameters -->
        <div id="agglomerative-params" class="algorithm-param-group" style="display: none;">
          <div class="row">
            <div class="col-md-6">
              <label for="agg-n-clusters" class="form-label">Number of clusters:</label>
              <input type="number" class="form-control" id="agg-n-clusters" value="3" min="2" max="10">
            </div>
            <div class="col-md-6">
              <label for="linkage" class="form-label">Linkage:</label>
              <select class="form-control" id="linkage">
                <option value="ward">Ward</option>
                <option value="complete">Complete</option>
                <option value="average">Average</option>
                <option value="single">Single</option>
              </select>
            </div>
          </div>
          <div class="row mt-3">
            <div class="col-md-12">
              <label class="form-label">Cluster count analysis:</label>
              <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-primary btn-sm" id="dendrogram-btn">Dendrogram</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Run Analysis Button -->
    <div class="text-center mb-4">
      <button id="run-analysis" class="btn btn-success btn-lg" disabled>
        Run Clustering Analysis
      </button>
    </div>

    <!-- Analysis Results -->
    <div id="analysis-results" class="step-container" style="display: none;">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="step-title mb-0">Cluster Count Analysis</h3>
        <button id="clear-analysis" class="btn btn-outline-secondary btn-sm">
          ✕ Clear
        </button>
      </div>
      <div id="analysis-container" class="text-center">
        <img id="analysis-image" class="img-fluid" style="max-width: 100%; height: auto;">
      </div>
      <div id="analysis-info" class="mt-3">
        <!-- Analysis information will be populated here -->
      </div>
    </div>

    <!-- Loading -->
    <div id="loading" class="loading">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-2">Running clustering analysis...</p>
    </div>

    <!-- Results -->
    <div id="results" class="result-section" style="display: none;">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="mb-0">Clustering Analysis Results</h3>
        <button id="clear-results" class="btn btn-outline-secondary btn-sm">
          ✕ Clear
        </button>
      </div>
      
      <!-- Statistics -->
      <div class="row mb-4">
        <div class="col-md-3">
          <div class="stats-card text-center">
            <h5 id="n-clusters-result">-</h5>
            <p class="text-muted mb-0">Number of clusters</p>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stats-card text-center">
            <h5 id="silhouette-score">-</h5>
            <p class="text-muted mb-0">Silhouette score</p>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stats-card text-center">
            <h5 id="n-noise">-</h5>
            <p class="text-muted mb-0">Noise (DBSCAN)</p>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stats-card text-center">
            <h5 id="total-points">-</h5>
            <p class="text-muted mb-0">Total points</p>
          </div>
        </div>
      </div>

      <!-- PCA Visualization -->
      <div class="mb-4">
        <h4>PCA Cluster Visualization</h4>
        <div class="text-center">
          <img id="pca-plot" class="img-fluid" style="max-width: 100%; height: auto;">
        </div>
      </div>

      <!-- Boxplots -->
      <div class="mb-4">
        <h4>EDA - Boxplots by Clusters</h4>
        <div class="text-center">
          <img id="boxplot" class="img-fluid" style="max-width: 100%; height: auto;">
        </div>
      </div>

      <!-- Cluster Statistics -->
      <div class="mb-4">
        <h4>Cluster Statistics</h4>
        <div id="cluster-stats" class="cluster-stats">
          <!-- Cluster statistics will be populated here -->
        </div>
      </div>

      <!-- Property Explorer -->
      <div class="mb-4" id="property-explorer" style="display: none;">
        <h4>Property Explorer</h4>
        <div class="card">
          <div class="card-body">
            <div class="row align-items-center">
              <div class="col-md-4">
                <label for="cluster-selector" class="form-label">Select Cluster:</label>
                <div class="d-flex align-items-center">
                  <input type="range" class="form-range me-3" id="cluster-selector" min="0" max="0" value="0" style="flex: 1;">
                  <span class="badge bg-primary fs-6" id="cluster-number">Cluster 0</span>
                </div>
              </div>
              <div class="col-md-4 text-center">
                <div class="d-flex justify-content-center">
                  <button type="button" class="btn btn-outline-primary" id="prev-property">
                    <i class="bi bi-chevron-left"></i> Previous Property
                  </button>
                  <span class="mx-3 align-self-center">
                    <span id="property-counter">1</span> of <span id="total-properties">0</span>
                  </span>
                  <button type="button" class="btn btn-outline-primary" id="next-property">
                    Next Property <i class="bi bi-chevron-right"></i>
                  </button>
                </div>
              </div>
              <div class="col-md-4 text-end">
                <button type="button" class="btn btn-outline-secondary btn-sm" id="prev-cluster">
                  <i class="bi bi-chevron-left"></i> Previous Cluster
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm ms-2" id="next-cluster">
                  Next Cluster <i class="bi bi-chevron-right"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Property Card -->
        <div class="card mt-3" id="property-card">
          <div class="card-header">
            <h5 class="mb-0" id="property-title">Property Details</h5>
          </div>
          <div class="card-body">
            <div id="property-details">
              <!-- Property details will be populated here -->
            </div>
          </div>
        </div>
        
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  

  <script>
    let selectedFeatures = [];
    let clusteringData = null;

    // Feature selection
    document.querySelectorAll('.feature-card').forEach(card => {
      card.addEventListener('click', function() {
        const feature = this.dataset.feature;
        
        if (this.classList.contains('selected')) {
          this.classList.remove('selected');
          selectedFeatures = selectedFeatures.filter(f => f !== feature);
        } else {
          this.classList.add('selected');
          selectedFeatures.push(feature);
        }
        
        // Hide analysis and clustering results when features change
        document.getElementById('analysis-results').style.display = 'none';
        document.getElementById('results').style.display = 'none';
        
        updateAnalysisButton();
      });
    });

    // Algorithm selection
    document.querySelectorAll('input[name="algorithm"]').forEach(radio => {
      radio.addEventListener('change', function() {
        // Hide all parameter groups
        document.querySelectorAll('.algorithm-param-group').forEach(group => {
          group.style.display = 'none';
        });
        
        // Hide analysis results when switching algorithms
        document.getElementById('analysis-results').style.display = 'none';
        
        // Hide clustering results when switching algorithms
        document.getElementById('results').style.display = 'none';
        
        // Reset analysis button states
        updateAnalysisButtonStates(null, false);
        
        // Show selected parameter group
        const selectedAlgorithm = this.value;
        document.getElementById(`${selectedAlgorithm}-params`).style.display = 'block';
      });
    });

    // Analysis buttons
    document.getElementById('silhouette-btn').addEventListener('click', function() {
      runAnalysis('silhouette');
    });

    document.getElementById('elbow-btn').addEventListener('click', function() {
      runAnalysis('elbow');
    });

    document.getElementById('dendrogram-btn').addEventListener('click', function() {
      runAnalysis('dendrogram');
    });

    // Clear analysis button
    document.getElementById('clear-analysis').addEventListener('click', function() {
      document.getElementById('analysis-results').style.display = 'none';
      updateAnalysisButtonStates(null, false);
    });

    // Clear results button
    document.getElementById('clear-results').addEventListener('click', function() {
      document.getElementById('results').style.display = 'none';
    });

    // Show histograms
    document.getElementById('show-histograms').addEventListener('click', function() {
      if (selectedFeatures.length === 0) return;
      
      const params = new URLSearchParams();
      selectedFeatures.forEach(feature => {
        params.append('features', feature);
      });
      
      fetch(`/api/clustering_histogram?${params}`)
        .then(response => response.json())
        .then(data => {
          document.getElementById('histogram-image').src = `data:image/png;base64,${data.image}`;
          document.getElementById('histogram-section').style.display = 'block';
        })
        .catch(error => {
          console.error('Error loading histograms:', error);
          alert('Error loading histograms');
        });
    });

    // Run analysis
    document.getElementById('run-analysis').addEventListener('click', function() {
      if (selectedFeatures.length < 2) {
        alert('Select at least 2 features for clustering');
        return;
      }

      // Collect per-feature scaler configuration
      const scalerConfig = {};
      selectedFeatures.forEach(feature => {
        const scalerRadio = document.querySelector(`input[name="scaler-${feature}"]:checked`);
        if (scalerRadio) {
          scalerConfig[feature] = scalerRadio.value;
        }
      });
      
      const algorithm = document.querySelector('input[name="algorithm"]:checked').value;
      
      let params = {};
      
      if (algorithm === 'kmeans') {
        params.n_clusters = parseInt(document.getElementById('n-clusters').value);
      } else if (algorithm === 'dbscan') {
        params.eps = parseFloat(document.getElementById('eps').value);
        params.min_samples = parseInt(document.getElementById('min-samples').value);
      } else if (algorithm === 'agglomerative') {
        const nClustersEl = document.getElementById('agg-n-clusters');
        const linkageEl = document.getElementById('linkage');
        
        if (!nClustersEl || !linkageEl) {
          alert('Error: Missing parameters for agglomerative clustering');
          return;
        }
        
        params.n_clusters = parseInt(nClustersEl.value);
        params.linkage = linkageEl.value;
      }

      const requestData = {
        features: selectedFeatures,
        scaler_config: scalerConfig,
        algorithm: algorithm,
        params: params
      };


      // Show loading
      document.getElementById('loading').style.display = 'block';
      document.getElementById('results').style.display = 'none';

      fetch('/api/clustering_analysis', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(requestData)
      })
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        document.getElementById('loading').style.display = 'none';
        
        if (data.error) {
          alert(`Chyba: ${data.error}`);
          return;
        }

        // Display results
        displayResults(data);
        document.getElementById('results').style.display = 'block';
      })
      .catch(error => {
        document.getElementById('loading').style.display = 'none';
        console.error('Error running analysis:', error);
        alert(`Error performing clustering analysis: ${error.message}`);
      });
    });

    function runAnalysis(analysisType) {
      if (selectedFeatures.length < 2) {
        alert('Select at least 2 features for analysis');
        return;
      }

      // Update button states
      updateAnalysisButtonStates(analysisType, true);

      // Collect per-feature scaler configuration
      const scalerConfig = {};
      selectedFeatures.forEach(feature => {
        const scalerRadio = document.querySelector(`input[name="scaler-${feature}"]:checked`);
        if (scalerRadio) {
          scalerConfig[feature] = scalerRadio.value;
        }
      });

      // Collect algorithm parameters for dendrogram
      let algorithmParams = {};
      if (analysisType === 'dendrogram') {
        const linkageSelect = document.getElementById('linkage');
        if (linkageSelect) {
          algorithmParams.linkage = linkageSelect.value;
        }
      }

      const requestData = {
        features: selectedFeatures,
        scaler_config: scalerConfig,
        analysis_type: analysisType,
        algorithm_params: algorithmParams
      };

      // Show loading
      document.getElementById('loading').style.display = 'block';
      document.getElementById('analysis-results').style.display = 'none';

      fetch('/api/cluster_analysis', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(requestData)
      })
      .then(response => response.json())
      .then(data => {
        document.getElementById('loading').style.display = 'none';
        updateAnalysisButtonStates(analysisType, false);
        
        if (data.error) {
          alert(data.error);
          return;
        }

        // Display analysis results
        displayAnalysisResults(data, analysisType);
        document.getElementById('analysis-results').style.display = 'block';
      })
      .catch(error => {
        document.getElementById('loading').style.display = 'none';
        updateAnalysisButtonStates(analysisType, false);
        console.error('Error running analysis:', error);
        alert('Error performing analysis');
      });
    }

    function updateAnalysisButtonStates(activeAnalysis, isLoading) {
      // Reset all buttons
      document.getElementById('silhouette-btn').className = 'btn btn-outline-primary btn-sm';
      document.getElementById('elbow-btn').className = 'btn btn-outline-primary btn-sm';
      document.getElementById('dendrogram-btn').className = 'btn btn-outline-primary btn-sm';
      
      // Disable all buttons during loading
      if (isLoading) {
        document.getElementById('silhouette-btn').disabled = true;
        document.getElementById('elbow-btn').disabled = true;
        document.getElementById('dendrogram-btn').disabled = true;
        
        // Add loading indicator to active button
        if (activeAnalysis === 'silhouette') {
          document.getElementById('silhouette-btn').innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Silhouette';
        } else if (activeAnalysis === 'elbow') {
          document.getElementById('elbow-btn').innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Elbow';
        } else if (activeAnalysis === 'dendrogram') {
          document.getElementById('dendrogram-btn').innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Dendrogram';
        }
        return;
      }
      
      // Re-enable all buttons and reset text
      document.getElementById('silhouette-btn').disabled = false;
      document.getElementById('elbow-btn').disabled = false;
      document.getElementById('dendrogram-btn').disabled = false;
      
      document.getElementById('silhouette-btn').innerHTML = 'Silhouette';
      document.getElementById('elbow-btn').innerHTML = 'Elbow';
      document.getElementById('dendrogram-btn').innerHTML = 'Dendrogram';
      
      // Highlight active analysis
      if (activeAnalysis === 'silhouette') {
        document.getElementById('silhouette-btn').className = 'btn btn-success btn-sm';
      } else if (activeAnalysis === 'elbow') {
        document.getElementById('elbow-btn').className = 'btn btn-success btn-sm';
      } else if (activeAnalysis === 'dendrogram') {
        document.getElementById('dendrogram-btn').className = 'btn btn-success btn-sm';
      }
    }

    function displayAnalysisResults(data, analysisType) {
      // Display the analysis image
      document.getElementById('analysis-image').src = `data:image/png;base64,${data.image}`;
      
      // Display analysis information
      const infoContainer = document.getElementById('analysis-info');
      infoContainer.innerHTML = '';
      
      if (analysisType === 'silhouette') {
        infoContainer.innerHTML = `
          <div class="alert alert-success">
            <h5>Silhouette Analysis</h5>
            <p><strong>Recommended number of clusters:</strong> ${data.best_k}</p>
            <p><strong>Best silhouette score:</strong> ${data.best_score.toFixed(3)}</p>
            <p class="mb-0">Higher score means better cluster separation. It is recommended to use ${data.best_k} clusters.</p>
          </div>
        `;
        
        // Update the cluster number input if it's visible
        const clusterInput = document.getElementById('n-clusters');
        if (clusterInput && clusterInput.offsetParent !== null) {
          clusterInput.value = data.best_k;
        }
        
      } else if (analysisType === 'elbow') {
        infoContainer.innerHTML = `
          <div class="alert alert-info">
            <h5>Elbow Method</h5>
            <p><strong>Recommended number of clusters:</strong> ${data.elbow_k}</p>
            <p class="mb-0">Elbow method looks for the point where the curve starts to "bend" - this indicates the optimal number of clusters.</p>
          </div>
        `;
        
        // Update the cluster number input if it's visible
        const clusterInput = document.getElementById('n-clusters');
        if (clusterInput && clusterInput.offsetParent !== null) {
          clusterInput.value = data.elbow_k;
        }
        
      } else if (analysisType === 'dendrogram') {
        const linkageMethod = data.linkage_method || 'ward';
        infoContainer.innerHTML = `
          <div class="alert alert-warning">
            <h5>Dendrogram Analysis (${linkageMethod.toUpperCase()} linkage)</h5>
            <p><strong>How to interpret dendrogram:</strong></p>
            <ul class="mb-0">
              <li>Horizontal lines show distances between clusters</li>
              <li>The longer the line, the greater the distance</li>
              <li>Choose the number of clusters based on where you want to "cut" the dendrogram</li>
              <li>Usually look for places with the largest jumps in distance</li>
              <li><strong>Linkage method:</strong> ${linkageMethod.toUpperCase()} - ${getLinkageDescription(linkageMethod)}</li>
            </ul>
          </div>
        `;
      }
    }

    function getLinkageDescription(method) {
      const descriptions = {
        'ward': 'minimizes variance within clusters',
        'complete': 'maximum distance between points in clusters',
        'average': 'average distance between points in clusters',
        'single': 'minimum distance between points in clusters'
      };
      return descriptions[method] || 'unknown method';
    }

    function updateAnalysisButton() {
      const button = document.getElementById('run-analysis');
      const histogramButton = document.getElementById('show-histograms');
      
      if (selectedFeatures.length >= 2) {
        button.disabled = false;
        histogramButton.disabled = false;
        updateFeatureScalerConfig();
      } else {
        button.disabled = true;
        histogramButton.disabled = true;
        document.getElementById('feature-scaler-config').style.display = 'none';
      }
    }

    function updateFeatureScalerConfig() {
      const container = document.getElementById('feature-scaler-config');
      container.innerHTML = '';
      
      if (selectedFeatures.length === 0) {
        container.style.display = 'none';
        return;
      }
      
      container.style.display = 'block';
      
      selectedFeatures.forEach(feature => {
        const featureNames = {
          'price_num': 'Price (CZK)',
          'rooms': 'Number of Rooms',
          'area_m2': 'Size (m²)',
          'price_per_m2': 'Price per m² (CZK)'
        };
        
        const featureDiv = document.createElement('div');
        featureDiv.className = 'row mb-3';
        featureDiv.innerHTML = `
          <div class="col-md-3">
            <label class="form-label"><strong>${featureNames[feature] || feature}:</strong></label>
          </div>
          <div class="col-md-9">
            <div class="row">
              <div class="col-md-3">
                <div class="form-check">
                  <input class="form-check-input scaler-radio" type="radio" name="scaler-${feature}" id="scaler-${feature}-standard" value="standard" checked>
                  <label class="form-check-label" for="scaler-${feature}-standard">
                    <small>Standard</small>
                  </label>
                </div>
              </div>
              <div class="col-md-3">
                <div class="form-check">
                  <input class="form-check-input scaler-radio" type="radio" name="scaler-${feature}" id="scaler-${feature}-minmax" value="minmax">
                  <label class="form-check-label" for="scaler-${feature}-minmax">
                    <small>MinMax</small>
                  </label>
                </div>
              </div>
              <div class="col-md-3">
                <div class="form-check">
                  <input class="form-check-input scaler-radio" type="radio" name="scaler-${feature}" id="scaler-${feature}-robust" value="robust">
                  <label class="form-check-label" for="scaler-${feature}-robust">
                    <small>Robust</small>
                  </label>
                </div>
              </div>
              <div class="col-md-3">
                <div class="form-check">
                  <input class="form-check-input scaler-radio" type="radio" name="scaler-${feature}" id="scaler-${feature}-power" value="power">
                  <label class="form-check-label" for="scaler-${feature}-power">
                    <small>Power</small>
                  </label>
                </div>
              </div>
            </div>
          </div>
        `;
        container.appendChild(featureDiv);
      });
      
      // Add event listeners for scaler changes
      document.querySelectorAll('.scaler-radio').forEach(radio => {
        radio.addEventListener('change', function() {
          // Hide analysis and clustering results when scaler changes
          document.getElementById('analysis-results').style.display = 'none';
          document.getElementById('results').style.display = 'none';
        });
      });
    }

    function displayResults(data) {
      // Update statistics
      document.getElementById('n-clusters-result').textContent = data.n_clusters;
      document.getElementById('silhouette-score').textContent = data.silhouette_score.toFixed(3);
      document.getElementById('n-noise').textContent = data.n_noise;
      document.getElementById('total-points').textContent = selectedFeatures.length > 0 ? 
        Object.values(data.cluster_stats).reduce((sum, cluster) => sum + Object.values(cluster)[0].count, 0) : 0;

      // Display PCA plot
      document.getElementById('pca-plot').src = `data:image/png;base64,${data.pca_plot}`;

      // Display boxplot
      document.getElementById('boxplot').src = `data:image/png;base64,${data.boxplot}`;

      // Initialize property explorer
      initializePropertyExplorer(data);

      // Display cluster statistics
      const statsContainer = document.getElementById('cluster-stats');
      statsContainer.innerHTML = '';
      
      Object.entries(data.cluster_stats).forEach(([clusterName, clusterData]) => {
        const clusterDiv = document.createElement('div');
        clusterDiv.className = 'stats-card mb-3';
        
        let statsHtml = `<h5>${clusterName.replace('_', ' ').toUpperCase()}</h5>`;
        
        Object.entries(clusterData).forEach(([feature, stats]) => {
          const featureNames = {
            'price_num': 'Price (CZK)',
            'rooms': 'Number of Rooms',
            'area_m2': 'Size (m²)',
            'price_per_m2': 'Price per m² (CZK)'
          };
          
          statsHtml += `
            <div class="row mb-2">
              <div class="col-md-3"><strong>${featureNames[feature] || feature}:</strong></div>
              <div class="col-md-9">
                Count: ${stats.count} | 
                Mean: ${stats.mean.toFixed(0)} | 
                Std: ${stats.std.toFixed(0)} | 
                Min: ${stats.min.toFixed(0)} | 
                Max: ${stats.max.toFixed(0)}
              </div>
            </div>
          `;
        });
        
        clusterDiv.innerHTML = statsHtml;
        statsContainer.appendChild(clusterDiv);
      });
    }

    // Initialize
    updateAnalysisButton();
    
    // Initialize algorithm parameter sections
    document.querySelectorAll('input[name="algorithm"]').forEach(radio => {
      if (radio.checked) {
        // Show the selected algorithm's parameter group
        const selectedAlgorithm = radio.value;
        const paramElement = document.getElementById(`${selectedAlgorithm}-params`);
        if (paramElement) {
          paramElement.style.display = 'block';
        }
      }
    });

    // Property Explorer Functions
    let propertyData = {};
    let currentCluster = 0;
    let currentProperty = 0;
    let maxClusters = 0;
    let maxProperties = 0;

    function initializePropertyExplorer(data) {
      propertyData = data.property_data;
      maxClusters = Object.keys(propertyData).length - 1;
      
      // Show property explorer
      document.getElementById('property-explorer').style.display = 'block';
      
      // Update slider
      const slider = document.getElementById('cluster-selector');
      slider.max = maxClusters;
      slider.value = 0;
      
      // Initialize first cluster
      updateClusterAndProperty(0, 0);
      
      // Add event listeners
      slider.addEventListener('input', function() {
        currentCluster = parseInt(this.value);
        currentProperty = 0;
        updateClusterAndProperty(currentCluster, currentProperty);
      });
      
      document.getElementById('prev-cluster').addEventListener('click', function() {
        if (currentCluster > 0) {
          currentCluster--;
          currentProperty = 0;
          slider.value = currentCluster;
          updateClusterAndProperty(currentCluster, currentProperty);
        }
      });
      
      document.getElementById('next-cluster').addEventListener('click', function() {
        if (currentCluster < maxClusters) {
          currentCluster++;
          currentProperty = 0;
          slider.value = currentCluster;
          updateClusterAndProperty(currentCluster, currentProperty);
        }
      });
      
      document.getElementById('prev-property').addEventListener('click', function() {
        if (currentProperty > 0) {
          currentProperty--;
          updatePropertyDisplay(currentCluster, currentProperty);
        }
      });
      
      document.getElementById('next-property').addEventListener('click', function() {
        if (currentProperty < maxProperties - 1) {
          currentProperty++;
          updatePropertyDisplay(currentCluster, currentProperty);
        }
      });
    }

    function updateClusterAndProperty(clusterIndex, propertyIndex) {
      const clusterName = `cluster_${clusterIndex}`;
      const clusterProperties = propertyData[clusterName];
      
      if (!clusterProperties || clusterProperties.length === 0) return;
      
      maxProperties = clusterProperties.length;
      currentProperty = Math.min(propertyIndex, maxProperties - 1);
      
      // Update cluster number badge
      document.getElementById('cluster-number').textContent = `Cluster ${clusterIndex}`;
      
      // Update total properties
      document.getElementById('total-properties').textContent = maxProperties;
      
      // Update property display
      updatePropertyDisplay(clusterIndex, currentProperty);
      
      // Update button states
      document.getElementById('prev-cluster').disabled = clusterIndex === 0;
      document.getElementById('next-cluster').disabled = clusterIndex === maxClusters;
    }

    function updatePropertyDisplay(clusterIndex, propertyIndex) {
      const clusterName = `cluster_${clusterIndex}`;
      const clusterProperties = propertyData[clusterName];
      
      if (!clusterProperties || propertyIndex >= clusterProperties.length) return;
      
      const property = clusterProperties[propertyIndex];
      
      // Update property counter
      document.getElementById('property-counter').textContent = propertyIndex + 1;
      
      // Update property title
      document.getElementById('property-title').textContent = `Property ${propertyIndex + 1} in Cluster ${clusterIndex}`;
      
      // Update property details
      const detailsContainer = document.getElementById('property-details');
      detailsContainer.innerHTML = '';
      
      const featureNames = {
        'price_num': 'Price (CZK)',
        'rooms': 'Number of Rooms',
        'area_m2': 'Size (m²)',
        'price_per_m2': 'Price per m² (CZK)'
      };
      
      // Create property card in the same style as the main list
      const propertyCard = document.createElement('div');
      propertyCard.className = 'row mb-4';
      
      const cardContent = `
        <div class="col">
          <div class="card shadow-sm">
            <div class="row g-0 align-items-center">
              <div class="col-md-5">
                ${property.image_url ? 
                  `<img src="${property.image_url}" class="img-fluid rounded-start" alt="Property image" style="height: 200px; object-fit: cover;">` :
                  `<div class="bg-secondary text-white d-flex align-items-center justify-content-center" style="min-height:200px;">
                    No Image Available
                  </div>`
                }
              </div>
              <div class="col-md-7">
                <div class="card-body">
                  <h5 class="card-title">${property.title || 'Property Listing'}</h5>
                  
                  <p class="card-text mb-1">
                    <strong>Price:</strong>
                    ${property.price_num ? 
                      `${property.price_num.toLocaleString().replace(/,/g, ' ')} CZK` : 
                      'Not available'
                    }
                  </p>
                  
                  <p class="card-text mb-1">
                    <strong>Price per m²:</strong>
                    ${property.price_per_m2 ? 
                      `${property.price_per_m2.toLocaleString().replace(/,/g, ' ')} CZK/m²` : 
                      '–'
                    }
                  </p>
                  
                  <p class="card-text mb-1">
                    <strong>Location:</strong> ${property.location || 'Not specified'}
                  </p>
                  
                  <p class="card-text mb-1">
                    <strong>Rooms:</strong>
                    ${property.rooms || '–'}
                    &nbsp;|&nbsp;
                    <strong>Size:</strong>
                    ${property.area_m2 ? `${property.area_m2} m²` : '– m²'}
                  </p>
                  
                  ${property.url ? 
                    `<a href="${property.url}" target="_blank" class="btn btn-primary btn-sm mt-2">
                      More Details
                    </a>` : 
                    ''
                  }
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
      
      propertyCard.innerHTML = cardContent;
      detailsContainer.appendChild(propertyCard);
      
      // Update property navigation buttons
      document.getElementById('prev-property').disabled = propertyIndex === 0;
      document.getElementById('next-property').disabled = propertyIndex === maxProperties - 1;
    }
  </script>
</body>
</html>
