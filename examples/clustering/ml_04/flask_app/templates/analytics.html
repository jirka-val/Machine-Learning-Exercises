<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Anal√Ωza cen</title>

  <!-- Bootstrap CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* Hover‚Äêcard styling */
    #hoverCard {
      position: absolute;
      z-index: 1000;
      display: none;
      width: 240px;
      pointer-events: none;
    }
  </style>
</head>
<body class="bg-light">
  <div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h1 class="m-0">Cenov√° anal√Ωza</h1>
      <div>
        <button id="refresh-data" class="btn btn-outline-primary btn-sm me-2">
          üîÑ Aktualizovat data
        </button>
        <button id="toggle-outliers" class="btn btn-outline-secondary btn-sm me-2">
          Odlehl√©
        </button>
        <a href="/clustering" class="btn btn-outline-success btn-sm">
          Clustering
        </a>
      </div>
    </div>

    <div id="stats" class="mb-4 text-muted"></div>
    <canvas id="scatterChart" height="100"></canvas>
    <p class="mt-4">
      <a href="/" class="btn btn-secondary">Zpƒõt na v√Ωpis</a>
    </p>
  </div>

  <!-- Hover-card -->
  <div id="hoverCard" class="card shadow-sm">
    <img
      id="hc-img"
      src=""
      class="card-img-top"
      style="max-height:120px; object-fit:cover; display:none;"
      onerror="this.style.display='none';"
      alt="Thumbnail"
    />
    <div class="card-body p-2">
      <h6 id="hc-title" class="card-title mb-1"></h6>
      <p id="hc-location" class="card-text mb-1" style="font-size:.85rem"></p>
      <p id="hc-rooms"    class="card-text mb-1" style="font-size:.85rem"></p>
      <!-- New total price line -->
      <p id="hc-total-price" class="card-text mb-1" style="font-size:.85rem"></p>
      <p id="hc-price"    class="card-text mb-1" style="font-size:.85rem"></p>
      <a id="hc-link" class="btn btn-outline-primary btn-sm w-100" target="_blank">
        V√≠ce detail≈Ø
      </a>
    </div>
  </div>

  <script>
    let records = {{ records | tojson | safe }};
    let scatterChart, allDatasets;
    let showOutliers = true;
    const ctx = document.getElementById('scatterChart');
    const hoverCard = document.getElementById('hoverCard');

    function computeStats(arr) {
      const n = arr.length;
      if (!n) return { n:0, mean:0, std:0, min:0, max:0 };
      const sum = arr.reduce((a,b)=>a+b,0);
      const mean = sum/n;
      const sq = arr.reduce((a,b)=>a + (b-mean)**2, 0);
      const std = Math.sqrt(sq/n);
      return { n, mean, std, min: Math.min(...arr), max: Math.max(...arr) };
    }

    function quantile(a,q) {
      const arr = [...a].sort((x,y)=>x-y);
      const pos=(arr.length-1)*q, base=Math.floor(pos), rest=pos-base;
      return arr[base+1]!==undefined
        ? arr[base] + rest*(arr[base+1]-arr[base])
        : arr[base];
    }

    function updateChart(){
      const valid = records.filter(r=>r.price_per_m2>=1);
      const prices = valid.map(r=>r.price_per_m2);
      const sorted = [...prices].sort((a,b)=>a-b);
      const q1 = quantile(sorted,.25), q3=quantile(sorted,.75), iqr=q3-q1;
      const lower=q1-1.5*iqr, upper=q3+1.5*iqr;

      const normal=[], outliers=[];
      valid.forEach((r,i)=>{
        const pt={x:r.price_per_m2,y:r.area_m2,idx:i};
        (r.price_per_m2<lower||r.price_per_m2>upper? outliers: normal).push(pt);
      });

      allDatasets=[
        {label:'Bƒõ≈æn√©',data:normal,backgroundColor:'rgba(54,162,235,0.6)',pointRadius:5},
        {label:'Odlehl√©',data:outliers,backgroundColor:'rgba(255,99,132,0.8)',pointRadius:5}
      ];

      // Stats
      const st=computeStats(prices);
      document.getElementById('stats').innerHTML=`
        <strong>Body:</strong> ${st.n}
        &nbsp;|&nbsp;<strong>Pr≈Ømƒõr:</strong> ${st.mean.toFixed(0).toLocaleString('cs-CZ')} Kƒç/m¬≤
        &nbsp;|&nbsp;<strong>Min:</strong> ${st.min.toLocaleString('cs-CZ')}
        &nbsp;|&nbsp;<strong>Max:</strong> ${st.max.toLocaleString('cs-CZ')}
        &nbsp;|&nbsp;<strong>Std:</strong> ${st.std.toFixed(0)}
      `;

      if(!scatterChart){
        scatterChart=new Chart(ctx,{
          type:'scatter',
          data:{datasets:allDatasets},
          options:{
            scales:{
              x:{title:{display:true,text:'Cena za m¬≤ (Kƒç)'}},
              y:{title:{display:true,text:'Velikost bytu (m¬≤)'}}
            },
            plugins:{tooltip:{enabled:false}},
            onHover(evt, elems, chart){
              if(!elems.length){
                hoverCard.style.display='none';
                return;
              }
              const {datasetIndex,index}=elems[0];
              const rec=valid[allDatasets[datasetIndex].data[index].idx];

              // Thumbnail
              const img=document.getElementById('hc-img');
              if(rec.image_url){
                img.src=rec.image_url; img.style.display='block';
              } else {
                img.style.display='none';
              }

              // Fill card
              document.getElementById('hc-title').innerText=rec.title;
              document.getElementById('hc-location').innerText='Lokace: '+rec.location;
              document.getElementById('hc-rooms').innerText='Pokoje: '+rec.rooms+' | Velikost: '+rec.area_m2+' m¬≤';
              // **Total price line**
              document.getElementById('hc-total-price').innerText=
                'Cena: '+rec.price_num.toLocaleString('cs-CZ')+' Kƒç';
              // Price/m¬≤
              document.getElementById('hc-price').innerText=
                'Cena/m¬≤: '+rec.price_per_m2.toLocaleString('cs-CZ')+' Kƒç/m¬≤';
              document.getElementById('hc-link').href=rec.url;

              // Position
              const meta=chart.getDatasetMeta(datasetIndex);
              const ptElem=meta.data[index];
              const px=ptElem.x, py=ptElem.y;
              const rect=chart.canvas.getBoundingClientRect();
              const absX=rect.left+px, absY=rect.top+py;
              const w=hoverCard.offsetWidth, h=hoverCard.offsetHeight;
              hoverCard.style.left=(absX-w/2)+'px';
              hoverCard.style.top=(absY-h-10)+'px';
              hoverCard.style.display='block';
            },
            onClick(evt, elems){
              if(!elems.length) return;
              const {datasetIndex,index}=elems[0];
              const rec=valid[allDatasets[datasetIndex].data[index].idx];
              window.open(rec.url,'_blank');
            }
          }
        });
      } else {
        scatterChart.data.datasets=showOutliers?allDatasets:[allDatasets[0]];
        scatterChart.update();
      }
    }

    document.getElementById('refresh-data')
      .addEventListener('click',()=>{
        fetch('/api/analytics_data')
          .then(r=>r.json())
          .then(j=>{records=j.records;updateChart();});
      });

    document.getElementById('toggle-outliers')
      .addEventListener('click',()=>{showOutliers=!showOutliers;updateChart();});

    // initial draw
    updateChart();
  </script>

  <!-- Bootstrap JS -->
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
  ></script>
</body>
</html>
